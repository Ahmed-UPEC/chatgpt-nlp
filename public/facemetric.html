<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>
    <link rel="stylesheet" href="css/facemetric.css">
    <title>FaceRecon</title>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/dist/face-api.js"></script>

</head>
<body>

    <!-- <video id="video" width="720" height="560" autoplay></video>
    <canvas id="canvas" width="720" height="560"></canvas> -->

    <button id="facemetric_startprocess">Start Process</button>

    <div class="modal-container">
        <div class="modal">
            <div class="modal-header">
                <p>Face Recognition</p>
                <img src="images/logo.png" alt="" style="justify-self: flex-end;width: 50px;margin-right: 10px;">
            </div>
            <div class="modal-body">
                <button id="start-camera" style="display: none;">Start Camera</button>
                <div class="modal-body-capture">
                    <!-- <video id="video" width="640" height="480" autoplay></video> -->
                    <video id="video" autoplay></video>
                    <!-- to draw the image -->
                    <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
                    <div class="modal-body-capture-info">
                        <h2>Make sure to be in visible light conditions and turn on the camera</h2>
                        <p>This is an automated process, please stand still in front of camera</p>
                    </div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <p>System developed by UPEC Master's Student</p>
                <p>Copyright 2024</p>
            </div>
        </div>
    </div>


    <script>
        // Face metric Modal Code

        let facemetric_startprocess = document.querySelector("#facemetric_startprocess");
        let facemetric_modal = document.querySelector(".modal-container");
        let facemetric_modal_bod_capture_info = document.querySelector(".modal-body-capture-info");
        let camera_button = document.querySelector("#start-camera");
        let video = document.querySelector("#video");
        let click_button = document.querySelector("#click-photo");
        let canvas = document.querySelector("#canvas");

        // enable UI - Facemetric
        facemetric_startprocess.addEventListener('click', function() {
            camera_button.click();
            document.querySelector(".modal-container").style.display = "flex";
        });

        camera_button.addEventListener('click', async function() {
            let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;

            
            setTimeout(async() => {
                // https://github.com/justadudewhohacks/face-api.js/tree/master/weights
                await faceapi.loadSsdMobilenetv1Model('/public/models')
                await faceapi.loadTinyFaceDetectorModel('/public/models')

                // hide video
                removeElementfromUI(video)
                // show canvas 
                canvas.style.display = "block";

                // to draw the image
                canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
                let image_data_url = canvas.toDataURL('image/png');
                let picture_base64 = image_data_url.split(',')[1];

                // Perform face detection on the canvas
                const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions());
                // one face detected = 1
                if (detections.length == 1) {
                    console.log('Face detected: ', detections);
                    console.log('Number of faces detected: ', detections.length);
                    // Additional actions for detected faces can be added here
                    sendToFlask(picture_base64);

                    // hide canvas
                    removeElementfromUI(canvas)
                    // end stream
                    stream.getTracks().forEach(function(track) {
                        track.stop();
                    });

                    facemetric_modal_bod_capture_info.innerHTML = `
                    <div style='display:flex'>
                        <img src="images/face_loader.gif"/>
                        <div style='display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:left'>
                            <h2 style='text-align:center;'>We are processing the information</h2>
                            <p style='text-align:center;'>Please wait a moment</p>
                        </div>
                    </div>
                    `
                } 
                else if (detections.length > 1) {
                    console.log('Multiple faces detected');
                    // Handle the case of multiple faces detected
                }
                else {
                    console.log('No face detected');
                    // Handle the case where no face is detected
                }

            }, 3000)

            

        });

        /* click_button.addEventListener('click', function(e) {
            canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
            let image_data_url = canvas.toDataURL('image/png');
            let picture_base64 = image_data_url.split(',')[1];
            sendToFlask(picture_base64);
        }); */

        async function sendToFlask(imageData) {
            //const url = "https://flask-python-2fjtj4bjkq-lm.a.run.app"
            const url = "https://e5fe-2a01-cb04-72e-2c00-4939-f01a-4e52-cf05.ngrok.io"
            fetch(url + "/faceapp", {
                method: 'POST',
                headers: {
                'Content-Type': 'text/plain',
                },
                //body: JSON.stringify({ image: imageData }),
                body: imageData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response from Flask app:', data);
                if (data.error) {
                    console.log("No face detected")
                    facemetric_modal_bod_capture_info.innerHTML = `
                    <div style='display:flex; justify-content:space-between;'>
                        <img src="images/unchecked.gif" class="checked"/>
                        <div style='display:flex;flex-direction:column;align-items:center;justify-content:center;'>
                            <h2 style='text-align:center;'>No face detected</h2>
                            <p style='text-align:center;'>Please try again</p>
                            <p style='text-align:center;'>
                                <em>Make sure to remove glasses to avoid reflections and be in a good light condition</em>    
                            </p>
                        </div>
                    </div>
                    
                    `;
                }
                else {
                    facemetric_modal_bod_capture_info.innerHTML = `
                    <div style='display:flex; justify-content:space-between;'>
                        <img src="images/checked.gif" class="checked"/>
                        <div style='display:flex;flex-direction:column;align-items:center;justify-content:center;'>
                            <h2 style='text-align:center;'>Processing done</h2>
                            <p style='text-align:center;'>Detect as ${data.result? data.result[0].split(".")[0] : 'undefined'}</p>
                        </div>
                    </div>
                    
                    `;
                    setTimeout(() => {
                        pinCodeVerification();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Error sending data to Flask app:', error);
            });
        }

        function removeElementfromUI(element) {
            element.remove();
        }

        function pinCodeVerification() {
            // remove facemetric_modal_bod_capture_info
            removeElementfromUI(facemetric_modal_bod_capture_info);
            let modal_body = document.querySelector(".modal-body");
            modal_body.innerHTML = `
                <div class='modal-body-pincode'>
                    <h2>Enter your pin code</h2>
                    <div class='grid'>
                        <div onclick=pinCodeVerificationDigit(this)>1</div>
                        <div onclick=pinCodeVerificationDigit(this)>2</div>
                        <div onclick=pinCodeVerificationDigit(this)>3</div>
                        <div onclick=pinCodeVerificationDigit(this)>4</div>
                        <div onclick=pinCodeVerificationDigit(this)>5</div>
                        <div onclick=pinCodeVerificationDigit(this)>6</div>
                        <div onclick=pinCodeVerificationDigit(this)>7</div>
                        <div onclick=pinCodeVerificationDigit(this)>8</div>
                        <div onclick=pinCodeVerificationDigit(this)>9</div>
                        <div onclick=pinCodeVerificationDigit(this)><</div>
                        <div onclick=pinCodeVerificationDigit(this)>0</div>
                        <div onclick=pinCodeVerificationDigit(this)>Ok</div>
                    </div>
                    <input type="text" id="passwordInput"/>
                    <input type='password' id='pincode' maxlength='8' />
                </div>
            `
        }

        function pinCodeVerificationDigit(e) {
            if (e.innerHTML == '<' || e.innerHTML == '&lt;') {
                let pincode = document.querySelector("#pincode");
                pincode.value = pincode.value.slice(0, -1);
                pincode = document.querySelector("#passwordInput");
                pincode.value = pincode.value.slice(0, -1);
            }
            else if (e.innerHTML == 'Ok') {
                let pincode = document.querySelector("#pincode");
                console.log(pincode.value);
                // TODO - send pincode to flask
            }
            else {
                // add pincode to input field but the input field max length is 8
                let pincode = document.querySelector("#pincode");
                if (pincode.value.length < 8) {
                    pincode.value += e.innerHTML;
                }
                pincode = document.querySelector("#passwordInput");
                if (pincode.value.length < 8) {
                    pincode.value += e.innerHTML;
                }
                displayPassword()
            }
            
        }

        function displayPassword() {
            var passwordInput = document.getElementById("passwordInput");
            var displayedPassword = "";

            for (var i = 0; i < passwordInput.value.length; i++) {
                displayedPassword += "*";
            }
            passwordInput.value = displayedPassword;
        }

    </script>

</body>
</html>